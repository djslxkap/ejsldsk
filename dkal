-- 罗布乐斯多功能脚本 v2.3
-- 作者: AI助手
-- 功能: 多种游戏功能 + 卡密验证系统 + 优化的显示隐藏功能 + 人物透视

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")

-- 卡密系统配置
local LicenseSystem = {
    ValidKeys = {
        "ROBLOX2024-PREMIUM-ULTRA",
        "GAMING-SCRIPT-PRO-MAX", 
        "FREE-SCRIPT-VIP-ACCESS",
        "TEST-KEY-1234567890",
        "ADMIN-ACCESS-ROBLOX-PRO"
    },
    
    ActivatedKeys = {},
    KeyExpiry = {},
    MaxActivations = 3
}

-- 透视系统
local ESPSystem = {
    Enabled = false,
    PlayerHighlights = {},
    HealthBars = {},
    NameTags = {}
}

-- 新的UI显示/隐藏系统
local UIVisibility = {
    IsVisible = true,
    ToggleKey = Enum.KeyCode.F5, -- 改为F5键切换显示/隐藏
    ToggleDelay = 0.2,
    LastToggle = 0
}

-- GUI 界面创建
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MultiScriptGUI_V2"
ScreenGui.Parent = game:GetService("CoreGui")

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 420, 0, 550)
MainFrame.Position = UDim2.new(0.5, -210, 0.5, -275)
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

-- 添加圆角效果
local MainCorner = Instance.new("UICorner")
MainCorner.CornerRadius = UDim.new(0, 12)
MainCorner.Parent = MainFrame

-- 标题栏
local TitleBar = Instance.new("Frame")
TitleBar.Size = UDim2.new(1, 0, 0, 45)
TitleBar.Position = UDim2.new(0, 0, 0, 0)
TitleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
TitleBar.Parent = MainFrame

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 12)
TitleCorner.Parent = TitleBar

-- 标题
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(0.7, 0, 1, 0)
Title.Position = UDim2.new(0.05, 0, 0, 0)
Title.BackgroundTransparency = 1
Title.Text = "🔧🔧 多功能脚本 v2.3"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 16
Title.Font = Enum.Font.GothamBold
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Parent = TitleBar

-- 控制按钮容器
local ControlButtons = Instance.new("Frame")
ControlButtons.Size = UDim2.new(0.4, 0, 1, 0)
ControlButtons.Position = UDim2.new(0.6, 0, 0, 0)
ControlButtons.BackgroundTransparency = 1
ControlButtons.Parent = TitleBar

-- 关闭按钮
local CloseButton = Instance.new("TextButton")
CloseButton.Size = UDim2.new(0, 30, 0, 30)
CloseButton.Position = UDim2.new(0.7, 0, 0.15, 0)
CloseButton.Text = "×"
CloseButton.BackgroundColor3 = Color3.fromRGB(232, 65, 56)
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.TextSize = 18
CloseButton.Font = Enum.Font.GothamBold
CloseButton.Parent = ControlButtons

local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(0, 6)
CloseCorner.Parent = CloseButton

-- 卡密输入区域
local KeySection = Instance.new("Frame")
KeySection.Size = UDim2.new(0.9, 0, 0, 80)
KeySection.Position = UDim2.new(0.05, 0, 0.1, 45)
KeySection.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
KeySection.Parent = MainFrame

local KeyCorner = Instance.new("UICorner")
KeyCorner.CornerRadius = UDim.new(0, 8)
KeyCorner.Parent = KeySection

-- 卡密输入框
local KeyBox = Instance.new("TextBox")
KeyBox.Size = UDim2.new(0.7, 0, 0, 35)
KeyBox.Position = UDim2.new(0.05, 0, 0.2, 0)
KeyBox.PlaceholderText = "🔑🔑 请输入卡密..."
KeyBox.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
KeyBox.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
KeyBox.TextColor3 = Color3.fromRGB(255, 255, 255)
KeyBox.TextSize = 14
KeyBox.Font = Enum.Font.Gotham
KeyBox.Parent = KeySection

local KeyBoxCorner = Instance.new("UICorner")
KeyBoxCorner.CornerRadius = UDim.new(0, 6)
KeyBoxCorner.Parent = KeyBox

-- 激活按钮
local ActivateButton = Instance.new("TextButton")
ActivateButton.Size = UDim2.new(0.2, 0, 0, 35)
ActivateButton.Position = UDim2.new(0.77, 0, 0.2, 0)
ActivateButton.Text = "激活"
ActivateButton.BackgroundColor3 = Color3.fromRGB(0, 140, 255)
ActivateButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ActivateButton.TextSize = 14
ActivateButton.Font = Enum.Font.GothamBold
ActivateButton.Parent = KeySection

local ActivateCorner = Instance.new("UICorner")
ActivateCorner.CornerRadius = UDim.new(0, 6)
ActivateCorner.Parent = ActivateButton

-- 状态显示
local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(0.9, 0, 0, 25)
StatusLabel.Position = UDim2.new(0.05, 0, 0.65, 0)
StatusLabel.Text = "📊📊 状态: 未激活"
StatusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
StatusLabel.BackgroundTransparency = 1
StatusLabel.TextSize = 12
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.Parent = KeySection

-- 功能按钮框架
local FunctionsFrame = Instance.new("ScrollingFrame")
FunctionsFrame.Size = UDim2.new(0.9, 0, 0, 350)
FunctionsFrame.Position = UDim2.new(0.05, 0, 0.25, 45)
FunctionsFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
FunctionsFrame.ScrollBarThickness = 5
FunctionsFrame.ScrollBarImageColor3 = Color3.fromRGB(100, 100, 120)
FunctionsFrame.CanvasSize = UDim2.new(0, 0, 2, 0)
FunctionsFrame.Parent = MainFrame

local FunctionsCorner = Instance.new("UICorner")
FunctionsCorner.CornerRadius = UDim.new(0, 8)
FunctionsCorner.Parent = FunctionsFrame

-- 功能按钮创建函数
local function CreateFunctionButton(name, description, position, callback)
    local ButtonFrame = Instance.new("Frame")
    ButtonFrame.Size = UDim2.new(0.95, 0, 0, 70)
    ButtonFrame.Position = position
    ButtonFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
    ButtonFrame.Parent = FunctionsFrame
    
    local ButtonCorner = Instance.new("UICorner")
    ButtonCorner.CornerRadius = UDim.new(0, 6)
    ButtonCorner.Parent = ButtonFrame
    
    local Button = Instance.new("TextButton")
    Button.Size = UDim2.new(0.9, 0, 0, 40)
    Button.Position = UDim2.new(0.05, 0, 0.1, 0)
    Button.Text = name
    Button.BackgroundColor3 = Color3.fromRGB(0, 140, 255)
    Button.TextColor3 = Color3.fromRGB(255, 255, 255)
    Button.TextSize = 14
    Button.Font = Enum.Font.GothamBold
    Button.Parent = ButtonFrame
    
    local ButtonBtnCorner = Instance.new("UICorner")
    ButtonBtnCorner.CornerRadius = UDim.new(0, 6)
    ButtonBtnCorner.Parent = Button
    
    local DescLabel = Instance.new("TextLabel")
    DescLabel.Size = UDim2.new(0.9, 0, 0, 20)
    DescLabel.Position = UDim2.new(0.05, 0, 0.7, 0)
    DescLabel.Text = description
    DescLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    DescLabel.BackgroundTransparency = 1
    DescLabel.TextSize = 11
    DescLabel.Font = Enum.Font.Gotham
    DescLabel.Parent = ButtonFrame
    
    -- 按钮悬停效果
    Button.MouseEnter:Connect(function()
        TweenService:Create(Button, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(30, 170, 255)}):Play()
    end)
    
    Button.MouseLeave:Connect(function()
        TweenService:Create(Button, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(0, 140, 255)}):Play()
    end)
    
    Button.MouseButton1Click:Connect(callback)
    
    return ButtonFrame
end

-- 创建功能按钮
local buttons = {
    {"🔍🔍 人物透视", "显示玩家模型和血量碰撞体", UDim2.new(0.025, 0, 0, 10)},
    {"⚡⚡ 速度提升", "增加角色移动速度", UDim2.new(0.025, 0, 0, 90)},
    {"🛡️🛡️ 无敌模式", "免疫伤害", UDim2.new(0.025, 0, 0, 170)},
    {"🔫🔫 无限弹药", "无限武器弹药", UDim2.new(0.025, 0, 0, 250)},
    {"💰💰 货币修改", "修改游戏货币", UDim2.new(0.025, 0, 0, 330)},
    {"🎯🎯 自动瞄准", "自动瞄准敌人", UDim2.new(0.025, 0, 0, 410)},
    {"🚀🚀 飞行模式", "启用飞行功能", UDim2.new(0.025, 0, 0, 490)},
    {"🌙🌙 夜视模式", "增强夜间视野", UDim2.new(0.025, 0, 0, 570)}
}

for i, buttonData in ipairs(buttons) do
    CreateFunctionButton(buttonData[1], buttonData[2], buttonData[3], function()
        if i == 1 then -- 人物透视按钮
            ToggleESP()
        else
            -- 其他功能按钮的处理
            print("功能开发中: " .. buttonData[1])
        end
    end)
end

-- 新的UI显示/隐藏功能
local function ToggleUI()
    local currentTime = tick()
    if currentTime - UIVisibility.LastToggle < UIVisibility.ToggleDelay then
        return
    end
    
    UIVisibility.LastToggle = currentTime
    UIVisibility.IsVisible = not UIVisibility.IsVisible
    
    if UIVisibility.IsVisible then
        MainFrame.Visible = true
        TweenService:Create(MainFrame, TweenInfo.new(0.3), {Size = UDim2.new(0, 420, 0, 550)}):Play()
    else
        TweenService:Create(MainFrame, TweenInfo.new(0.3), {Size = UDim2.new(0, 0, 0, 0)}):Play()
        delay(0.3, function()
            MainFrame.Visible = false
        end)
    end
end

-- 人物透视系统
local function CreateESP(player)
    if ESPSystem.PlayerHighlights[player] then
        return
    end
    
    local highlight = Instance.new("Highlight")
    highlight.FillColor = Color3.fromRGB(255, 50, 50)
    highlight.FillTransparency = 0.3
    highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
    highlight.OutlineTransparency = 0
    highlight.Parent = player.Character
    
    -- 血量显示
    local billboard = Instance.new("BillboardGui")
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = player.Character
    
    local healthLabel = Instance.new("TextLabel")
    healthLabel.Size = UDim2.new(1, 0, 1, 0)
    healthLabel.BackgroundTransparency = 1
    healthLabel.Text = player.Name .. "\nHP: 100"
    healthLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    healthLabel.TextSize = 14
    healthLabel.Font = Enum.Font.GothamBold
    healthLabel.Parent = billboard
    
    -- 碰撞体显示
    local boundingBox = Instance.new("Part")
    boundingBox.Size = Vector3.new(4, 6, 2)
    boundingBox.Transparency = 0.7
    boundingBox.Material = Enum.Material.Neon
    boundingBox.BrickColor = BrickColor.new("Bright red")
    boundingBox.Anchored = true
    boundingBox.CanCollide = false
    boundingBox.Parent = player.Character
    
    ESPSystem.PlayerHighlights[player] = highlight
    ESPSystem.HealthBars[player] = {billboard = billboard, label = healthLabel}
    ESPSystem.BoundingBoxes[player] = boundingBox
    
    -- 更新血量
    local function UpdateHealth()
        if player.Character and player.Character:FindFirstChild("Humanoid") then
            local humanoid = player.Character.Humanoid
            healthLabel.Text = player.Name .. "\nHP: " .. math.floor(humanoid.Health)
            
            -- 更新碰撞体位置
            if boundingBox and player.Character:FindFirstChild("HumanoidRootPart") then
                boundingBox.Position = player.Character.HumanoidRootPart.Position
            end
        end
    end
    
    -- 监听血量变化
    if player.Character and player.Character:FindFirstChild("Humanoid") then
        player.Character.Humanoid.HealthChanged:Connect(UpdateHealth)
    end
    
    player.CharacterAdded:Connect(function(character)
        wait(1) -- 等待角色加载完成
        if highlight then highlight:Destroy() end
        if billboard then billboard:Destroy() end
        if boundingBox then boundingBox:Destroy() end
        
        CreateESP(player)
    end)
end

local function RemoveESP(player)
    if ESPSystem.PlayerHighlights[player] then
        ESPSystem.PlayerHighlights[player]:Destroy()
        ESPSystem.PlayerHighlights[player] = nil
    end
    
    if ESPSystem.HealthBars[player] then
        ESPSystem.HealthBars[player].billboard:Destroy()
        ESPSystem.HealthBars[player] = nil
    end
    
    if ESPSystem.BoundingBoxes[player] then
        ESPSystem.BoundingBoxes[player]:Destroy()
        ESPSystem.BoundingBoxes[player] = nil
    end
end

local function ToggleESP()
    ESPSystem.Enabled = not ESPSystem.Enabled
    
    if ESPSystem.Enabled then
        -- 为所有玩家创建ESP
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= Players.LocalPlayer then
                CreateESP(player)
            end
        end
        
        -- 监听新玩家加入
        Players.PlayerAdded:Connect(function(player)
            CreateESP(player)
        end)
        
        print("🔍🔍 人物透视已启用")
    else
        -- 移除所有ESP
        for player, _ in pairs(ESPSystem.PlayerHighlights) do
            RemoveESP(player)
        end
        
        print("🔍🔍 人物透视已禁用")
    end
end

-- 键盘快捷键
UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end
    
    if input.KeyCode == UIVisibility.ToggleKey then
        ToggleUI()
    end
end)

-- 关闭按钮事件
CloseButton.MouseButton1Click:Connect(function()
    TweenService:Create(MainFrame, TweenInfo.new(0.3), {Size = UDim2.new(0, 0, 0, 0)}):Play()
    delay(0.3, function()
        ScreenGui:Destroy()
    end)
end)

-- 激活按钮事件
ActivateButton.MouseButton1Click:Connect(function()
    local key = KeyBox.Text
    if table.find(LicenseSystem.ValidKeys, key) then
        StatusLabel.Text = "📊📊 状态: 已激活 ✓"
        StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
        print("✅✅ 卡密验证成功!")
    else
        StatusLabel.Text = "📊📊 状态: 卡密无效 ✗"
        StatusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        print("❌❌ 卡密验证失败!")
    end
end)

-- 启动动画
MainFrame.Size = UDim2.new(0, 0, 0, 0)
MainFrame.Visible = true
TweenService:Create(MainFrame, TweenInfo.new(0.5), {Size = UDim2.new(0, 420, 0, 550)}):Play()

print("🎮🎮 多功能脚本 v2.3 已加载!")
print("=== 新功能 ===")
print("🖥️🖥️ UI控制: F5键切换显示/隐藏")
print("🔍🔍 人物透视: 显示玩家模型、血量和碰撞体")
print("💡💡 提示: 按F5可快速隐藏/显示界面")
